name: "{{SERVICE_NAME}}"
scheduler:
  role: "{{SERVICE_NAME}}-role"
  principal: "{{SERVICE_NAME}}-principal"
  zookeeper: master.mesos:2181
pods:
  cockroachdb:
    count: {{NODES_COUNT}}
    uris:
      - "https://binaries.cockroachdb.com/{{SERVICE_BINARY_VERSION}}.tgz"
      - "https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64"
      - "https://downloads.mesosphere.com/dcos-commons/artifacts/bootstrap.zip"
    tasks:
      nodes:
        cpus: {{NODES_CPUS}}
        memory: {{NODES_MEM}}
        ports:
          cockroachdb-port:
            port: {{NODES_PORT}}
            vip:
              prefix: "cockroachdb"
              port: {{NODES_PORT}}
          cockroachdb-http-port:
            port: {{NODES_HTTP_PORT}}
            vip:
              prefix: "cockroachdb-http"
              port: {{NODES_HTTP_PORT}}
        volume:
          path: "data"
          type: "{{NODES_VOLUME_TYPE}}"
          size: {{NODES_VOLUME_SIZE}}
        goal: RUNNING
        # TODO: Switch back to using the start.sh script after figuring out local dev env issues
        # cmd: "env && ./bootstrap && ls -l && find ./ && chmod +x $MESOS_SANDBOX/start.sh && exec $MESOS_SANDBOX/start.sh"
        cmd: "env && ./bootstrap && ls -l && find ./ && exec ./{{SERVICE_BINARY_VERSION}}/cockroach start --insecure --logtostderr --advertise-host ${TASK_NAME}.${FRAMEWORK_NAME}.mesos --http-host 0.0.0.0 --port {{NODES_PORT}} --http-port {{NODES_HTTP_PORT}}"
        health-check:
          cmd: "curl --fail ${LIBPROCESS_IP}:{{NODES_PORT}} > /dev/null"
          interval: 30
          grace-period: 60
          max-consecutive-failures: 5
          delay: 5
          timeout: 5
        #configs:
          #start-sh:
            #template: "{{CONFIG_TEMPLATE_PATH}}/start.sh.mustache"
            #dest: "$MESOS_SANDBOX/start.sh"
        env:
          SERVICE_NAME: {{SERVICE_NAME}}
          NODES_PORT: {{NODES_PORT}}

plans:
  deploy:
    strategy: serial
    phases:
      launch-first-node:
        strategy: serial
        pod: cockroachdb
      scale-other-nodes:
        strategy: parallel
        pod: cockroachdb
